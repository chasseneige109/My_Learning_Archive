노이즈를 주입할 때 **공분산 행렬($\Sigma$)**이 등장하는 이유는 우리가 다루는 데이터가 숫자 하나가 아니라 **여러 개의 픽셀로 이루어진 이미지(벡터/행렬)**이기 때문입니다.

질문하신 두 가지 포인트(왜 쓰는지, 무엇을 쓰는지)를 명확히 나누어 설명해 드릴게요.

---

### 1. 왜 공분산 행렬이 들어가는가? (Why Covariance Matrix?)

우리가 더하려는 노이즈 $\mathbf{z}$는 **다차원(Multivariate) 가우시안 분포**를 따릅니다. 다차원 공간에서 노이즈의 **"퍼지는 모양"**을 결정하려면 공분산 행렬이 반드시 필요합니다.

보통 사용하는 식은 다음과 같습니다.

$$\Sigma_t = \sigma_t^2 \mathbf{I}$$

여기서 공분산 행렬이 하는 역할은 두 가지입니다.

1. **독립성 보장 ($\mathbf{I}$의 역할):**
    
    - 행렬 $\mathbf{I}$(단위 행렬)를 쓴다는 것은 **"1번 픽셀에 노이즈가 낀다고 해서 2번 픽셀이 따라 변하지 않는다"**는 뜻입니다.
        
    - 즉, 모든 픽셀에 **서로 상관없이(Independent)** 각각 알아서 노이즈를 뿌리겠다는 선언입니다.
        
2. **크기 조절 ($\sigma_t^2$의 역할):**
    
    - 모든 픽셀에 뿌려질 노이즈의 **세기(강도)**를 결정합니다.
        

**결론:** "이미지 전체 픽셀($64 \times 64$)에 동시에 노이즈를 뿌려야 하니 행렬이 필요하고, 각 픽셀마다 **공평하고 독립적으로** 뿌리기 위해 $\mathbf{I}$가 포함된 공분산 행렬을 씁니다."

---

### 2. 어떤 공분산($\sigma_t^2$)을 쓰는가? (Which Variance?)

DDPM 논문(Ho et al., 2020)에서는 두 가지 선택지가 있다고 제시했습니다. 결론부터 말하면 **둘 다 결과는 비슷하지만, 이론적 의미가 다릅니다.**

#### 옵션 A: $\sigma_t^2 = \beta_t$ (Forward Process의 분산)

- **의미:** 학습시킬 때 노이즈를 더했던 양($\beta_t$)만큼, 생성할 때도 똑같이 노이즈를 더해주겠다는 것입니다.
    
- **특징:**
    
    - 가장 단순하고 직관적입니다.
        
    - 논문 저자들이 실험해 보니 이걸 써도 이미지가 잘 나왔습니다.
        
    - **Upper Bound (상한선):** 불확실성을 최대로 잡은 경우입니다.
        

#### 옵션 B: $\sigma_t^2 = \tilde{\beta}_t$ (Posterior의 분산)

- 의미: 아까 증명했던 이상적인 분포 $q(x_{t-1}|x_t, x_0)$의 분산 수식을 그대로 가져다 쓰는 것입니다.
    
    $$\tilde{\beta}_t = \frac{1-\bar{\alpha}_{t-1}}{1-\bar{\alpha}_t} \beta_t$$
    
- **특징:**
    
    - 수학적으로 더 정교합니다. (Lower Bound, 하한선)
        
    - $t$가 클 때는 $\beta_t$와 거의 값이 똑같습니다.
        
    - **차이점:** $t=1$ (마지막 단계) 근처에 가면 $\tilde{\beta}_t$는 0에 가까워집니다. (마지막엔 노이즈를 안 넣는 게 맞으니까요.) 반면 $\beta_t$는 여전히 값이 큽니다.
        

---

### 3. 실제로는 뭘 더 많이 써?

1. **기본 DDPM:** **옵션 A ($\beta_t$)**를 주로 썼습니다. 구현이 쉽고 성능 차이가 미미했기 때문입니다.
    
2. Improved DDPM (발전된 모델): 옵션 A와 옵션 B 사이의 값을 신경망이 학습하도록 만듭니다.
    
    $$\Sigma_\theta(x_t, t) = \exp(v \log \beta_t + (1-v) \log \tilde{\beta}_t)$$
    
    ($v$라는 값을 학습시켜서 상황에 맞게 노이즈 양을 조절함)
    

### 요약

1. **공분산 행렬 쓰는 이유:** 픽셀이 여러 개인 이미지에 **"각각 독립적으로($\mathbf{I}$)"** 노이즈를 뿌리기 위해서.
    
2. **어떤 값:** 보통 **$\beta_t$** (Forward 때 쓴 값)를 그대로 쓰거나, 더 정교하게는 **$\tilde{\beta}_t$** (수학적 정답 분산)를 씁니다. 둘 다 큰 차이는 없습니다.